<!DOCTYPE html>
<html>
<head>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="serial.js" defer></script>
  <script src="lol.js" defer></script>
  <script src="wearable_blocks.js" defer></script>
  <script src="wearable_generator.js" defer></script>
  <script src="wear_workspace.js" defer></script>
  <link rel="stylesheet" href="lol.css">

  <script src="blockly_helper.js"></script>
  <script src="Blob.js" defer></script>
  <script src="FileSaver.min.js" defer></script>

  <meta charset="utf-8">
<!--  <title>Blockly Demo: Generating JavaScript</title> -->
<!--  <script type="text/javascript" src="../blockly_compressed.js"></script>
  <script type="text/javascript" src="../blocks_compressed.js"></script>
  <script type="text/javascript" src="../javascript_compressed.js"></script>
  <script type="text/javascript" src="../msg/js/en.js"></script> -->

  <script type="text/javascript" src="blockly_compressed.js"></script>
  <script type="text/javascript" src="blocks_compressed.js"></script>
  <script type="text/javascript" src="javascript_compressed.js"></script>
  <script type="text/javascript" src="en.js"></script>


  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 100%;
    }
  </style>

</head>
<body>

<main id="main">
    <h1>Pitsco - Codeable Wearables</h1

   <section class="panel">

    <div class="connection">
        <p id="device"></p>
        <button id="connect">connect</button>
    </div>

<form id="form">
<!--    <p>Message:</p>
    <input type="text" id="text" autofocus required autocapitalize maxlength="100">
        <input type="submit" value="send"> -->

    </form>
    </section>
</main>


  <p>

    <button onclick="showCode()">Show Code</button>
    <button onclick="sendCode()">Send Code</button>
<!--    <button onclick="importCode()">Import Code</button> -->
<!--    <button onclick="exportCode()">Export Code</button> -->
    <button onclick="backup_blocks()">Backup Blocks</button>
    <button onclick="restore_blocks()">Restore Blocks</button>
    <button onclick="document.getElementById('file-input').click();">Open Blocks</button>
        <input id="file-input" type="file" name="name" onchange="readFiles(this.files)" style="display: none;" />
    <button onclick="save()">Download Blocks</button>
    <button onclick="discard()">Delete All Blocks</button>

  </p>

  <div id="blocklyDiv" style="height: 640px; width: 100%;"></div> 

  <div id="blocklyDiv" style="position: absolute"></div>

  <script>
  var blocklyArea = document.getElementById('blocklyArea');
  var blocklyDiv = document.getElementById('blocklyDiv');
  var workspace = Blockly.inject(blocklyDiv,
      {toolbox: document.getElementById('toolbox')});
  var onresize = function(e) {
    // Compute the absolute coordinates and dimensions of blocklyArea.
    var element = blocklyArea;
    var x = 0;
    var y = 0;
    do {
      x += element.offsetLeft;
      y += element.offsetTop;
      element = element.offsetParent;
    } while (element);
    // Position blocklyDiv over blocklyArea.
    blocklyDiv.style.left = x + 'px';
    blocklyDiv.style.top = y + 'px';
    blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
    blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
    Blockly.svgResize(workspace);
  };
  window.addEventListener('resize', onresize, false);
  onresize();
  Blockly.svgResize(workspace);
</script>

  <xml id="toolbox" style="display: none">

<!--    <new expanded blocks> -->
      <category name = "Control">
        <block type="exp_start"></block>
        <block type="exp_end"></block>
        <block type="exp_if_block"></block>
        <block type="cube_if_else"></block>
        <block type="cube_loop_until"></block>
        <block type="cube_loop_forever"></block>
        <block type="exp_repeat"></block>
        <block type="cube_wait_until"></block>
        <block type="exp_delay"></block>
      </category>

      <category name = "Sensing">
        <block type="sense_tilt"></block>
        <block type="sense_facing"></block>
     </category>

      <category name = "Matrix">
        <block type="exp_show_image"></block>
        <block type="exp_character"></block>
        <block type="matrix_pixel"></block>
        <block type="matrix_row"></block>
        <block type="matrix_column"></block>
        <block type="matrix_fill"></block>
        <block type="matrix_fade"></block>
        <block type="matrix_bright"></block>
        <block type="matrix_strobe"></block>
        <block type="matrix_flash"></block>
        <block type="matrix_clear"></block>
        <block type="matrix_scroll"></block>
        <block type="pixel_matrix"></block>
      </category>

      <category name = "Sound">
        <block type="exp_sound"></block>
        <block type="exp_tone"></block>
        <block type="exp_note"></block>
      </category>

<!--    <category name = "image">
        <block type="frame_strip_15"></block>
    </category>
    <category name = "logic">
        <block type="wear_logic"></block>
    </category>
    <category name = "action">
        <block type="just_go_statement"></block>
        <block type="tilt_up"></block>
        <block type="tilt_down"></block>
        <block type="tilt_left"></block>
        <block type="tilt_right"></block>
        <block type="no_tilt"></block>
    </category>
    <category name = "pause">
        <block type="wait_025_seconds"></block>
        <block type="wait_05_seconds"></block>
        <block type="wait_1_second"></block>
        <block type="wait_2_seconds"></block>
        <block type="wait_3_seconds"></block>
        <block type="wait_4_seconds"></block>
        <block type="wait_5_seconds"></block>
    </category>       -->


  </xml>

  <script>



    function readFiles(){
      var files = event.target.files;
      // Only allow uploading one file.
      if (files.length != 1) {
        return;
      }

      // FileReader
      var reader = new FileReader();
      reader.onloadend = function(event) {
        var target = event.target;
        // 2 == FileReader.DONE
        if (target.readyState == 2) {
          try {
            var xml = Blockly.Xml.textToDom(target.result);
          } catch (e) {
            alert('Error parsing XML:\n' + e);
            return;
          }
          var count = Blockly.mainWorkspace.getAllBlocks().length;
          if (count && confirm('Replace existing blocks?\n"Cancel" will merge.')) {
            Blockly.mainWorkspace.clear();
          }
          Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
        }
        // Reset value of input after loading because Chrome will not fire
        // a 'change' event if the same file is loaded again.
        document.getElementById('load').value = '';
      };
      reader.readAsText(files[0]);
    }


  //  var demoWorkspace = Blockly.inject('blocklyDiv',
  //      {media: '../media/',
  //      toolbox: document.getElementById('toolbox')});
  //      Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
  //                               demoWorkspace);



    function importCode(){
      var xml_text = localStorage.getItem("myfile");
       if (xml_text) {
         var xml = Blockly.Xml.textToDom(xml_text);
         Blockly.Xml.domToWorkspace(workspace, xml);
      }
    }

    function exportCode(){
     var xml = Blockly.Xml.workspaceToDom(workspace);
     var xml_text = Blockly.Xml.domToText(xml);
     localStorage.setItem("myfile", xml_text);
    }

    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
  //  var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
      var code = Blockly.JavaScript.workspaceToCode(workspace);
  //    alert(code);
      console.log(code);
    }

    function sendCode(){
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      const textInput = code;
  		port.send(new TextEncoder("utf-8").encode(textInput));
    }

    function runCode() {
      // Generate JavaScript code and run it.
      window.LoopTrap = 1000;
      Blockly.JavaScript.INFINITE_LOOP_TRAP =
          'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }
    }
  </script>

</body>
</html>
